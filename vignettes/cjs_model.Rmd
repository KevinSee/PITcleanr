---
title: "Preparing Data for a Cormack-Jolly-Seber (CJS) model"
author: Kevin See
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Querying, Compressing, and Making Sense of PIT Tag Detection Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = "hide"}
# knitr options
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  comment = "#>"
)

library(knitr)
library(here)
```

# Introduction

This vignette shows how to use the `PITcleanr` package to wrangle PIT tag data to fit a Cormack-Jolly-Seber model to estimate detection probabilities and survival parameters for juvenile salmon smolts moving downstream, from the Upper Lemhi rotary screw trap all the way to Bonneville Dam on the Columbia River. 

# PTAGIS Data

* queried PTAGIS for Chinook tags that were marked or recaptured at LEMTRP between Aug 1, 2021 and July 31, 2022
* queried PTAGIS for MRR data on all tags
* composed a list of tags
* queried PTAGIS for complete tag history of those tags

# Wrangle Capture Histories

```{r}
# read in PTAGIS detections
ptagis_file = here('inst/extdata/LEMTRP',
                   "LEMTRP_chnk_cth_2021.csv")

# ptagis_file <- system.file("extdata", 
#                            "LEMTRP_chnk_cth_2021.csv", 
#                            package = "PITcleanr",
#                            mustWork = TRUE)

ptagis_cth <- readCTH(ptagis_file) |>
  arrange(tag_code,
          event_date_time_value)

# qcTagHistory(ptagis_cth,
#              ignore_event_vs_release = T)

```

The configuration file we will use starts with the standard PTAGIS configuration information. For this example we will not concern ourselves with various arrays or antennas at individual sites, but instead we define nodes by their site codes. The first of two exceptions is any sites downstream of Bonneville Dam (river kilometer 234). Because our CJS model will only extend downstream to Bonneville, we will combine all detections below Bonneville with detections at Bonneville, using site B2J. The other exception is to combine the spillway arrays at Lower Granite Dam (site code "GRS") with other juvenile bypass antennas ("GRJ") there, because we are not interested in how fish pass Lower Granite dam, only if they do and are detected somewhere while doing so.

```{r, eval = F}
configuration <-
  buildConfig(node_assign = "site") |> 
   mutate(across(node,
                ~ if_else(as.numeric(str_sub(rkm, 1, 3)) <= 234,
                          "B2J",
                          .)),
         across(node,
                ~ if_else(site_code == "GRS",
                          "GRJ",
                          .))) |>
  filter(!is.na(node))
```

```{r, echo = F}
configuration <- system.file("extdata", 
                          "LEMTRP_configuration.csv", 
                          package = "PITcleanr",
                          mustWork = TRUE) |> 
  read_csv(show_col_types = F)

```

## Build Parent Child Table

Based on the complete tag histories from PTAGIS, and our slightly modified configuration file, we will determine which sites to include in our CJS model. The function `extractSites` in the `PITcleanr` package will pull out all the nodes where any of our tags were detected and has the ability to turn that into a spatial object (i.e. an `sf` object) using the latitude and longitude information in the configuration file. 

```{r}
sites_sf <-
  extractSites(ptagis_cth,
               as_sf = T,
               configuration = configuration,
               max_date = "20220630") |>
  arrange(desc(rkm))

sites_sf
```

From here, we could build a parent-child table by hand (see the [Parent-Child Tables](parent_child.html) vignette). To build it using some of the functionality of `PITcleanr`, continue below.

There are a few screwtraps on the mainstem Salmon River or in a tributary to the Salmon that we are not interested in using. We can filter those by only keeping site from Lower Granite downstream, or sites within the Lemhi basin. Some of these sites are on tributaries of the Lemhi River, and we are not interested in keeping those sites (since we don't anticipate every fish necessarily moving past those sites)

```{r}
sites_sf <-
  sites_sf |> 
  left_join(configuration |> 
              select(site_code, 
                     rkm_total) |> 
              distinct()) |> 
  filter(nchar(rkm) <= 7 |
           (str_detect(rkm, "522.303.416") &
              rkm_total <= rkm_total[site_code == "LEMTRP"] &
              nchar(rkm) == 15),
         site_code != "HAYDNC")
```

Once the sites have been finalized, we query the NHDPlus v2 flowlines from USGS, using the `queryFlowlines` function in `PITcleanr`. 

```{r, eval = F}
nhd_list = queryFlowlines(sites_sf,
                          root_site_code = "LEMTRP",
                          min_strm_order = 2,
                          dwnstrm_sites = T,
                          dwn_min_stream_order_diff = 4)

# compile the upstream and downstream flowlines
flowlines = nhd_list$flowlines |>
  rbind(nhd_list$dwn_flowlines)
```

```{r, echo = F}
flowlines <- system.file("extdata", 
                          "LEMTRP_flowlines.gpkg", 
                          package = "PITcleanr",
                          mustWork = TRUE) |>
  st_read(quiet = T)
```

