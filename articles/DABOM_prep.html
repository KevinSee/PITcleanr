<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preparing Data for DABOM • PITcleanr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preparing Data for DABOM">
<meta property="og:description" content="PITcleanr">
<meta property="og:image" content="https://kevinsee.github.io/PITcleanr/index.html/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PITcleanr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Getting Started</li>
    <li>
      <a href="../articles/Prep_PIT_data.html">Querying, Compressing, and Making Sense of PIT Tag Detection Data</a>
    </li>
    <li class="divider">
    <li>
      <a href="../articles/index.html">More...</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/KevinSee/PITcleanr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="DABOM_prep_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preparing Data for DABOM</h1>
                        <h4 class="author">Kevin See</h4>
            
            <h4 class="date">17 September, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/KevinSee/PITcleanr/blob/master/vignettes/DABOM_prep.Rmd"><code>vignettes/DABOM_prep.Rmd</code></a></small>
      <div class="hidden name"><code>DABOM_prep.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>One purpose of the <code>PITcleanr</code> package is to prepare PIT tag observations for the Dam Adult Branch Occupancy Model (<a href="https://github.com/BiomarkABS/DABOM">DABOM</a>). DABOM estimates upstream movement probabilities across a branching stream network. One of the major assumptions in that model is that fish are making a one-way trip upstream, meaning they aren’t moving into one tributary, turning around and moving into another. In reality, such movements certainly happen, but those detections must be “cleaned” before running the model. This means that if a tag is detected in multiple branches, someone must decide which branch (i.e, stream or river) represents their spawning trajectory, and the detections from the other branches must be deleted. <code>PITcleanr</code> can examine complete tag histories from <a href="https://www.ptagis.org/">PTAGIS</a> for a list of tags and help identify which tags have detections in multiple branches, and provide a suggestion for which detections to retain.</p>
<p>In this vignette, we will also use many functions from the <code>tidyverse</code> <a href="https://www.tidyverse.org/">group of packages</a>, so we load that as well:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KevinSee/PITcleanr">PITcleanr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>Many of the following sections are also included in the introductory <code>PITcleanr</code> vignette which can be accessed <a href="Prep_PIT_data.html">here</a>. That vignette explains additional functionality available from <code>PITcleanr</code> and can also be accessed using:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"Prep_PIT_data"</span>,
         package <span class="op">=</span> <span class="st">"PITcleanr"</span><span class="op">)</span></code></pre></div>
<div id="outline" class="section level2">
<h2 class="hasAnchor">
<a href="#outline" class="anchor"></a>Outline</h2>
<p>The core of <code>PITcleanr</code>’s functionality relies on a query of complete tag histories or detections from <a href="https://www.ptagis.org/">PTAGIS</a>, a configuration file that maps those detections onto user-defined “nodes”, and a parent-child relationship showing how those nodes are related to each other on a stream network (i.e., which nodes are connected). This vignette describes the use of <code>PITcleanr</code> to prepare each of these for use in the <a href="https://github.com/BiomarkABS/DABOM">DABOM</a> R package. We cover the following:</p>
<ul>
<li>
<a href="#querying-detection-data-from-ptagis">Querying Detection Data from PTAGIS</a>: Instructions on how to query the complete tag history for tags of interest using <a href="https://www.ptagis.org/">PTAGIS</a>.</li>
<li>
<a href="#compressing-data">Compressing Data</a>: How to compress the complete tag histories from <a href="https://www.ptagis.org/">PTAGIS</a> into a more reasonable number of records for further analysis.</li>
<li>
<a href="#site-configuration">Site Configuration</a>: By default, <code>PITcleanr</code> defines site codes from <a href="https://www.ptagis.org/">PTAGIS</a> as “nodes”. However, the user may define their own “nodes” by providing a site configuration file. Nodes are used to describe the spatial scale the user would like detections to be summarized at e.g., an individual antenna, arrays, sites, or possibly even larger (e.g., any detection in <strong>this</strong> watershed). For most analyses, the “node” will likely be either a site, or the array (or even groups of arrays if there are more than 2 arrays at a site).</li>
<li>
<a href="#parent-child-relationships">“Parent-Child” Relationships</a>: For <a href="https://github.com/BiomarkABS/DABOM">DABOM</a>, we need to know how “nodes” are connected to each other on a stream network i.e., which sites are upstream or downstream of each other. We describe the process for how to build a table of parent-child relationships.</li>
<li>[Remove Detections Prior to a Start Date]: Sometimes the user may identify detections in their analysis that occur prior to a date (or even location) of interest. We demonstrate how you could remove those.</li>
<li>
<a href="#create-straightforward-detection-histories">Create “Straightforward” Detection Histories</a>: One of the major assumptions of <a href="https://github.com/BiomarkABS/DABOM">DABOM</a> is that fish are making a one-way trip upstream. In reality, that’s not always the case, and we demonstrate how <code>PITcleanr</code> can be used to identify “errant” detections and remove them prior to running <a href="https://github.com/BiomarkABS/DABOM">DABOM</a>.</li>
</ul>
<p>Good luck!</p>
</div>
</div>
<div id="data-prep-for-dabom" class="section level1">
<h1 class="hasAnchor">
<a href="#data-prep-for-dabom" class="anchor"></a>Data Prep for DABOM</h1>
<div id="querying-detection-data-from-ptagis" class="section level2">
<h2 class="hasAnchor">
<a href="#querying-detection-data-from-ptagis" class="anchor"></a>Querying Detection Data from PTAGIS</h2>
<p>The Columbia Basin PIT Tag Information System (<a href="https://ptagis.org/">PTAGIS</a>) is the centralized regional database for PIT-tag detections within the Columbia River Basin. It contains a record of each detection of every PIT tag, including the initial detection, or “mark”, when the tag is implanted in the fish, detections on PIT-tag antennas, recaptures (e.g. at weirs) and recoveries (e.g. carcass surveys). It contains a record of every individual detection, which means potentially multiple records of a tag being detected on the same antenna over and over e.g., in the case that it is not moving. Therefore, querying PTAGIS for all of these detections leads to a wealth of data, which can be unwieldy for the user. <code>PITcleanr</code> aims to compress that data to a more manageable size, without losing any of the information contained in that dataset.</p>
<p><code>PITcleanr</code> starts with a complete capture history query from <a href="https://ptagis.org/">PTAGIS</a> for a select group of tags of interest. The user will need to compile this list of tags themselves, ideally in a .txt file with one row per tag number, to make it easy to upload to a PTAGIS query.</p>
<p>For convenience, we’ve included one such file with <code>PITcleanr</code>. The following code can be used to find the path to that example file that was installed with the package, titled “tag_list_TUM_2015.txt”, containing IDs for Chinook salmon adults implanted with PIT tags at Tumwater Dam in 2015. Feel free to copy/paste that file to use as a template for creating your own tag list, in which case, you can follow along with your own tags of interest.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, 
            <span class="st">"tag_list_TUM_2015.txt"</span>, 
            package <span class="op">=</span> <span class="st">"PITcleanr"</span>,
            mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>The example file of tag codes is very simple:</p>
<pre><code>#&gt; # A tibble: 2,019 x 1
#&gt;    X1            
#&gt;    &lt;chr&gt;         
#&gt;  1 384.3B239AD241
#&gt;  2 3D9.1BF24B20F5
#&gt;  3 3D9.1C2D76FB78
#&gt;  4 3D9.1C2D770193
#&gt;  5 3D9.1C2D91B3DE
#&gt;  6 3D9.1C2D925C52
#&gt;  7 3D9.1C2D929849
#&gt;  8 3D9.1C2D93282A
#&gt;  9 3D9.1C2DB9A65E
#&gt; 10 3D9.1C2DC026E4
#&gt; # … with 2,009 more rows</code></pre>
<p>Once the user has created their own tag list, or located this example one, they can go to the <a href="https:://www.ptagis/org">PTAGIS homepage</a> to query the complete tag histories for those tags. To do so, navigate the the <a href="https:://www.ptagis/org">homepage</a> and go to the <a href="https://www.ptagis.org/data/advanced-reporting">Advanced Reporting</a> page, which can also be found under the Data tab on the homepage. To access Advanced Reporting, the user will need a free account from PTAGIS, and to be logged in. Once on the Advanced Reporting page, select “Launch” and create a custom query by selecting “Create Query Builder2 Report”, and choosing the “Complete Tag History” query type.</p>
<p>There are several query indices on the left side of the query builder, but for the purposes of <code>PITcleanr</code> only a few are needed. First, under “1 Select Attributes” the following fields are required to work with <code>PITcleanr</code>:</p>
<ul>
<li>Tag</li>
<li>Mark Species</li>
<li>Mark Rear Type</li>
<li>Event Type</li>
<li>Event Site Type</li>
<li>Event Site Code</li>
<li>Event Date Time</li>
<li>Antenna</li>
<li>Antenna Group Configuration</li>
<li>Event Release Site Code</li>
<li>Event Release Date Time</li>
</ul>
<p>Simply move these fields over to the “Selected:” column on the page. Other fields may be included as well, but the ones listed above must be added. Any additional fields will just be included as extra columns in the query output.</p>
<p>The only other required index is “2 Select Metrics”, but that can remain as the default, “CTH Count”, which provides one record for each event recorded per tag.</p>
<p>Set up a filter for specific tags by next navigating to the “29 Tag Code - List or Text File” on the left. And then, after selecting “Tag” under “Attributes:”, click on “Import file…”. Simply upload the .txt file containing your PIT tag codes of interest, or alternatively, feel free to use the “tag_list_TUM_2015.txt” file provided with <code>PITcleanr</code>. After choosing the file, click on “Import” and the tag list will be loaded (delimited by semi-colons). Click “OK”.</p>
<p>Under “Report Message Name:” near the bottom, name the query something appropriate, such as “TUM_Chinook_2015”, and select “Run Report”. Once the query has successfully completed, the output can be exported as a .csv file (e.g. “TUM_Chinook_2015.csv”). Simply click on the “Export” icon near the top, which will open a new page, and select the default settings:</p>
<ul>
<li>Export: Whole report</li>
<li>CSV file format</li>
<li>Export Report Title: unchecked</li>
<li>Export filter details: unchecked</li>
<li>Remove extra column: Yes</li>
</ul>
<p>And click “Export”, again. We have included an example of data downloaded from PTAGIS with the <code>PITcleanr</code> package. The user can identify where that example file has been saved by running the following code. The file path will be stored as a new object <code>ptagis_file</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptagis_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, 
                          <span class="st">"TUM_Chinook_2015.csv"</span>, 
                          package <span class="op">=</span> <span class="st">"PITcleanr"</span>,
                          mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Alternatively, if the user has run a query from PTAGIS as described above, they could set <code>ptagis_file</code> to the path and file name of the .csv they downloaded.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># As an example, set path to PTAGIS query output</span>
<span class="va">ptagis_file</span> <span class="op">=</span> <span class="st">"C:/Users/usernamehere/Downloads/TUM_Chinook_2015.csv"</span></code></pre></div>
<p>Note that in our example file, there are 24938 detections (rows) for 2019 unique tags, matching the number of tags in our example tag list “tag_list_TUM_2015.txt”. For a handful of those tags, in our case 178, there is only a “Mark” detection i.e., that tag was never detected again after the fish was tagged and released. For the remaining, there are many tags often detected at the same site and sometimes on the same antenna. Data like this, while full of information, can be difficult to analyze efficiently. To illustrate, here is an example of the raw data for a single tag:</p>
<table class="table">
<colgroup>
<col width="5%">
<col width="6%">
<col width="7%">
<col width="6%">
<col width="12%">
<col width="8%">
<col width="8%">
<col width="4%">
<col width="13%">
<col width="11%">
<col width="11%">
<col width="3%">
</colgroup>
<thead><tr class="header">
<th align="left">Tag Code</th>
<th align="left">Mark Species Name</th>
<th align="left">Mark Rear Type Name</th>
<th align="left">Event Type Name</th>
<th align="left">Event Site Type Description</th>
<th align="left">Event Site Code Value</th>
<th align="left">Event Date Time Value</th>
<th align="left">Antenna ID</th>
<th align="right">Antenna Group Configuration Value</th>
<th align="left">Event Release Site Code Code</th>
<th align="left">Event Release Date Time Value</th>
<th align="right">CTH Count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Mark</td>
<td align="left">River Segment</td>
<td align="left">COLR2</td>
<td align="left">5/14/2015 8:10:00 AM</td>
<td align="left">NA</td>
<td align="right">0</td>
<td align="left">COLR2</td>
<td align="left">5/14/2015 12:14:00 PM</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Instream Remote Detection System</td>
<td align="left">CHL</td>
<td align="left">8/30/2015 9:24:46 PM</td>
<td align="left">85</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Instream Remote Detection System</td>
<td align="left">LWE</td>
<td align="left">6/6/2015 7:28:38 AM</td>
<td align="left">09</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Instream Remote Detection System</td>
<td align="left">WTL</td>
<td align="left">6/22/2015 9:04:18 PM</td>
<td align="left">03</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:01:16 PM</td>
<td align="left">17</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:05:58 PM</td>
<td align="left">14</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:05:59 PM</td>
<td align="left">14</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:06:06 PM</td>
<td align="left">12</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:06:07 PM</td>
<td align="left">12</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:41:54 PM</td>
<td align="left">10</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:41:55 PM</td>
<td align="left">10</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:44:18 PM</td>
<td align="left">0E</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:44:19 PM</td>
<td align="left">0E</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:44:20 PM</td>
<td align="left">0E</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:44:25 PM</td>
<td align="left">0C</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:48:14 PM</td>
<td align="left">0A</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:48:15 PM</td>
<td align="left">0A</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:48:22 PM</td>
<td align="left">08</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:48:23 PM</td>
<td align="left">08</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:51:39 PM</td>
<td align="left">08</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:51:40 PM</td>
<td align="left">08</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO3</td>
<td align="left">5/26/2015 1:56:13 PM</td>
<td align="left">04</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:47:32 PM</td>
<td align="left">04</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:47:33 PM</td>
<td align="left">04</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:50:26 PM</td>
<td align="left">03</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:50:27 PM</td>
<td align="left">03</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:51:48 PM</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:51:49 PM</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">BO4</td>
<td align="left">5/26/2015 2:51:50 PM</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:24:45 AM</td>
<td align="left">13</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:24:46 AM</td>
<td align="left">13</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:25:12 AM</td>
<td align="left">10</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:29:36 AM</td>
<td align="left">0F</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:30:02 AM</td>
<td align="left">0D</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:30:03 AM</td>
<td align="left">0D</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:33:26 AM</td>
<td align="left">0B</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:35:04 AM</td>
<td align="left">08</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:38:53 AM</td>
<td align="left">06</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:38:54 AM</td>
<td align="left">06</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 8:40:20 AM</td>
<td align="left">04</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 9:15:49 AM</td>
<td align="left">03</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 9:15:50 AM</td>
<td align="left">02</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 9:15:51 AM</td>
<td align="left">02</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">MC2</td>
<td align="left">5/31/2015 9:15:55 AM</td>
<td align="left">01</td>
<td align="right">120</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">PRA</td>
<td align="left">6/3/2015 8:01:42 AM</td>
<td align="left">04</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">PRA</td>
<td align="left">6/3/2015 8:08:53 AM</td>
<td align="left">01</td>
<td align="right">110</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">TD2</td>
<td align="left">5/27/2015 10:12:50 PM</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">TD2</td>
<td align="left">5/27/2015 10:12:51 PM</td>
<td align="left">02</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">TD2</td>
<td align="left">5/27/2015 10:13:03 PM</td>
<td align="left">01</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">TUF</td>
<td align="left">6/14/2015 8:11:21 PM</td>
<td align="left">A2</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Observation</td>
<td align="left">Adult Fishway</td>
<td align="left">TUF</td>
<td align="left">6/14/2015 9:00:23 PM</td>
<td align="left">A1</td>
<td align="right">100</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">3D9.1BF24B20F5</td>
<td align="left">Chinook</td>
<td align="left">Unknown</td>
<td align="left">Recapture</td>
<td align="left">Dam</td>
<td align="left">TUM</td>
<td align="left">3/6/2015 2:05:00 PM</td>
<td align="left">NA</td>
<td align="right">0</td>
<td align="left">TUMFBY</td>
<td align="left">6/14/2015 11:59:00 PM</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>Congratulations! You now have complete tag histories for your tags of interest from <a href="https://www.ptagis.org/">PTAGIS</a>! Next, we’ll demonstrate how to compress all of those records into a more manageable size.</p>
</div>
<div id="compressing-data" class="section level2">
<h2 class="hasAnchor">
<a href="#compressing-data" class="anchor"></a>Compressing Data</h2>
<p>The complete tag history query output from <a href="https://ptagis.org/">PTAGIS</a> (e.g., <code>ptagis_file</code>) will provide a record for every detection of each tag code in the tag list. Again, this may include multiple detections on the same antenna, or the same site within a short period of time, leading to an unwieldy and perhaps messy dataset. One of the main purposes of <code>PITcleanr</code> is to compress that data into an initial summary using the function <code><a href="../reference/compress.html">compress()</a></code>. At a minimum, this function requires a path e.g., <code>ptagis_file</code>, to the complete tag history query results downloaded from PTAGIS.</p>
<p>In our example, we perform the <code><a href="../reference/compress.html">compress()</a></code> function on the <code>ptagis_file</code> object containing the file path to our query results, and write the output to an object <code>comp_obs</code> containing the compressed observations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># view path to example file, of course you can also set ptagis_file to your own PTAGIS query results</span>
<span class="va">ptagis_file</span>
<span class="co">#&gt; [1] "/Users/seek/Library/R/4.0/library/PITcleanr/extdata/TUM_Chinook_2015.csv"</span>

<span class="co"># run compress() function on it</span>
<span class="va">comp_obs</span> <span class="op">=</span> <span class="fu"><a href="../reference/compress.html">compress</a></span><span class="op">(</span><span class="va">ptagis_file</span><span class="op">)</span>

<span class="co"># look at first parts of resulting object</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">comp_obs</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 9</span>
<span class="co">#&gt;   tag_code       node    slot event_type_name n_dets min_det            </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;  &lt;int&gt; &lt;chr&gt;            &lt;int&gt; &lt;dttm&gt;             </span>
<span class="co">#&gt; 1 384.3B239AD241 NASONC     1 Mark                 1 2013-11-04 16:45:00</span>
<span class="co">#&gt; 2 384.3B239AD241 JDJ        2 Observation         12 2014-05-25 11:14:29</span>
<span class="co">#&gt; 3 384.3B239AD241 BO4        3 Observation         11 2015-05-14 16:41:24</span>
<span class="co">#&gt; 4 384.3B239AD241 TD1        4 Observation          3 2015-05-16 11:15:40</span>
<span class="co">#&gt; 5 384.3B239AD241 MC2        5 Observation         17 2015-05-19 17:01:15</span>
<span class="co">#&gt; 6 384.3B239AD241 PRA        6 Observation          2 2015-05-24 13:51:16</span>
<span class="co">#&gt; # … with 3 more variables: max_det &lt;dttm&gt;, duration &lt;drtn&gt;, travel_time &lt;drtn&gt;</span></code></pre></div>
<p>The output consists of a tibble containing columns for:</p>
<ul>
<li>
<strong>tag_code:</strong> The unique PIT tag ID.</li>
<li>
<strong>node:</strong> By default, each site code from PTAGIS is considered a node. More on this below…</li>
<li>
<strong>slot:</strong> A detection “slot” for each tag, numbered in chronological order. Also more on this below…</li>
<li>
<strong>event_type_name:</strong> The type of “event”. Typically, mark, observation, recapture, or recovery.</li>
<li>
<strong>n_dets:</strong> The number of detections that occurred within that slot.</li>
<li>
<strong>min_det:</strong> The time of the first (min) detection in the slot.</li>
<li>
<strong>max_det:</strong> The time of the last (max) detection in the slot.</li>
<li>
<strong>duration:</strong> The duration of that slot (maximum - minimum detection time).</li>
<li>
<strong>travel_time:</strong> The travel time between the previous slot and that one.</li>
</ul>
<p><strong><em>A note on “nodes”</em></strong>: A node is the spatial scale of interest for the user. By default, the <code><a href="../reference/compress.html">compress()</a></code> function considers a site code from PTAGIS as a node. However, a node could be defined as the individual PIT antenna a detection was made on, or the array that antenna is a part of, or groups of arrays, or sites, or groups of sites, or possibly even larger (e.g, any detection in <strong>this</strong> tributary!) depending on the spatial scale desired. The user may decide to define some arrays at particular sites to be their own nodes, while simultaneously lumping all the sites in a particular watershed into a single node. To utilize this kind of grouping, a configuration file or table must be supplied to the <code>configuration</code> argument in the <code><a href="../reference/compress.html">compress()</a></code> function. This configuration file helps map what node each antenna or MRR site corresponds to. By default, <code>compress</code> assigns each site code to its own node.</p>
<p>Each slot in the output is defined as all detections on a particular node before the tag is detected on a different node. The user can define a maximum number of minutes between detections before a new slot should be defined by supplying a value to the <code>max_minutes</code> argument to <code><a href="../reference/compress.html">compress()</a></code>. The units of the duration and travel_time columns can also be defined by the <code>units</code> argument. The default is minutes (<code>mins</code>). As an example, if a tag moves from node A to B and back to A, there will be three slots in the compressed data.</p>
<p>The help menu for <code><a href="../reference/compress.html">compress()</a></code>, or any function for that matter, can be accessed using:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">?</span><span class="fu">PITcleanr</span><span class="fu">::</span><span class="va"><a href="../reference/compress.html">compress</a></span></code></pre></div>
</div>
<div id="site-configuration" class="section level2">
<h2 class="hasAnchor">
<a href="#site-configuration" class="anchor"></a>Site Configuration</h2>
<p><code>PITcleanr</code> includes a function <code><a href="../reference/buildConfig.html">buildConfig()</a></code> that maps each array (row of antennas) at a site onto a node. Using <code><a href="../reference/buildConfig.html">buildConfig()</a></code>, the upstream arrays are labeled with the site code plus <code>A0</code> and the downstream arrays are assigned <code>B0</code>. For sites with three arrays, the middle array is grouped with the upstream array. For sites with four arrays, the upper two arrays are mapped to <code>A0</code> and the lower two arrays are mapped to <code>B0</code>. Alternatively, the user could use <a href="https://ptagis.org/sites">metadata from PTAGIS</a> (also see <code><a href="../reference/queryPtagisMeta.html">?queryPtagisMeta</a></code>) and construct this mapping any way they choose. This type of configuration file (or tibble or data frame) can be provided to the <code>configuration</code> argument in <code><a href="../reference/compress.html">compress()</a></code> to assign each detection to it’s associated node.</p>
<p>In the following example, we use the <code><a href="../reference/buildConfig.html">buildConfig()</a></code> function to generate a default configuration and save it as <code>array_configuration</code>. Several sites are then consolidated into a single node (e.g. LNF, TUM), and some mark-recovery-recapture sites are merged with upstream array nodes, and the modified configuration is saved as <code>configuration</code> which can then be fed to the <code><a href="../reference/compress.html">compress()</a></code> function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">array_configuration</span> <span class="op">=</span> <span class="fu"><a href="../reference/buildConfig.html">buildConfig</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Querying INT sites' metadata</span>
<span class="co">#&gt; Querying INT sites' configuration information</span>
<span class="co">#&gt; Querying MRR sites' metadata</span>

<span class="co"># customize some pieces</span>
<span class="va">configuration</span> <span class="op">=</span> <span class="va">array_configuration</span> <span class="op">%&gt;%</span>
  <span class="co"># first, for example, 'LNF' and 'LEAV' are re-coded into a single node 'LNF'</span>
  <span class="fu">mutate</span><span class="op">(</span>node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'LNF'</span>, <span class="st">'LEAV'</span><span class="op">)</span>,
                       <span class="st">'LNF'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         <span class="co"># these three nodes are all re-coded to a single 'TUM'</span>
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'TUF'</span>, <span class="st">'TUMFBY'</span>, <span class="st">'TUM'</span><span class="op">)</span>,
                       <span class="st">'TUM'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'CHIWAC'</span>,
                       <span class="st">'CHWA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CHIWAR'</span>, <span class="st">'CHIWAT'</span><span class="op">)</span>,
                       <span class="st">'CHLA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'CHIW'</span>,
                       <span class="st">'CHLA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         <span class="co"># In this case, PIT tags from carcass recoveries in the Chikamin River are</span>
         <span class="co"># grouped with the upper 'CHU' array</span>
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'CHIKAC'</span>,
                       <span class="st">'CHUA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'NASONC'</span>,
                       <span class="st">'NALA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'WHITER'</span>,
                       <span class="st">'WTLA0'</span>,
                       <span class="va">node</span><span class="op">)</span>,
         node <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">site_code</span> <span class="op">==</span> <span class="st">'LWENAT'</span>,
                       <span class="st">'LWNA0'</span>,
                       <span class="va">node</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Now, re-run the <code><a href="../reference/compress.html">compress()</a></code> function, except supplying a <code>configuration</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># re-run compress(), providing configuration</span>
<span class="va">comp_obs</span> <span class="op">=</span> <span class="fu"><a href="../reference/compress.html">compress</a></span><span class="op">(</span><span class="va">ptagis_file</span>,
                    configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span>

<span class="co"># look at first part of comp_obs</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">comp_obs</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 9</span>
<span class="co">#&gt;   tag_code       node   slot event_type_name n_dets min_det            </span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt; &lt;int&gt; &lt;chr&gt;            &lt;int&gt; &lt;dttm&gt;             </span>
<span class="co">#&gt; 1 384.3B239AD241 NALA0     1 Mark                 1 2013-11-04 16:45:00</span>
<span class="co">#&gt; 2 384.3B239AD241 JDJ       2 Observation         12 2014-05-25 11:14:29</span>
<span class="co">#&gt; 3 384.3B239AD241 BO4       3 Observation         11 2015-05-14 16:41:24</span>
<span class="co">#&gt; 4 384.3B239AD241 TD1       4 Observation          3 2015-05-16 11:15:40</span>
<span class="co">#&gt; 5 384.3B239AD241 MC2       5 Observation         17 2015-05-19 17:01:15</span>
<span class="co">#&gt; 6 384.3B239AD241 PRA       6 Observation          2 2015-05-24 13:51:16</span>
<span class="co">#&gt; # … with 3 more variables: max_det &lt;dttm&gt;, duration &lt;drtn&gt;, travel_time &lt;drtn&gt;</span></code></pre></div>
<p>Note: If the user has their own site configuration file ready or would like a template to create their own configuration file, those directions can be found in <a href="quick_prep.Rmd">this</a> vignette.</p>
</div>
<div id="mapping-detection-sites" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-detection-sites" class="anchor"></a>Mapping Detection Sites</h2>
<p>At this point you’ve queried all of the PTAGIS detections for your tags of interest, compressed those detections, and mapped them to the default or to custom “nodes” of interest using site configuration information. Next, we need to build the parent-child relationships among all of our “nodes” which describes the relative location of each node to other nodes i.e., which nodes are upstream or downstream of each other. We will describe how to build a table of parent-child relationships shortly, but to accomplish that, we first need to extract our sites and locations of interest and download the flowlines connecting them to understand how sites fall on the stream or river network.</p>
<div id="extract-sites-of-interest" class="section level3">
<h3 class="hasAnchor">
<a href="#extract-sites-of-interest" class="anchor"></a>Extract Sites of Interest</h3>
<p>The <code><a href="../reference/queryPtagisMeta.html">queryPtagisMeta()</a></code> and <code><a href="../reference/buildConfig.html">buildConfig()</a></code> functions in <code>PITcleanr</code> return information from <strong>all</strong> INT and MRR sites in PTAGIS. However, the user may only be interested in detections from site codes found within their complete tag history output downloaded from PTAGIS e.g., your <code>ptagis_file</code>. The <code><a href="../reference/extractSites.html">extractSites()</a></code> function does just that: extracts the site codes found in the complete tag history. In addition, the detections can be filtered by a minimum and/or maximum detection date, and the results are returned as either a tibble, or as a simple (spatial) feature <code>sf</code> object. Setting the <code>min_date</code> argument could be useful if the user is not interested in detections at sites prior to your study period e.g., detections that occur prior to fish arriving at your tagging or release location.</p>
<p>In this example, we create a new object <code>sites_sf</code>, return it as an <code>sf</code> object (by setting <code>as_sf = T</code>) and only return sites from those detections that occurred after May 1, 2015. We also extract sites only from the Wenatchee subbasin and remove a couple sites that we perhaps don’t care about. More information on simple features (<code>sf</code> objects) can be found <a href="https://r-spatial.github.io/sf/">here</a>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sites_sf</span> <span class="op">=</span> <span class="fu"><a href="../reference/extractSites.html">extractSites</a></span><span class="op">(</span><span class="va">ptagis_file</span>,
                        as_sf <span class="op">=</span> <span class="cn">T</span>,
                        min_date <span class="op">=</span> <span class="st">"20150501"</span>,
                        configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span>
<span class="co"># focus on sites within Wenatchee subbasin</span>
<span class="va">sites_sf</span> <span class="op">=</span> <span class="va">sites_sf</span> <span class="op">%&gt;%</span>
  <span class="co"># all sites in the Wenatchee have a river kilometer that starts with 754</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"754."</span>, <span class="va">rkm</span><span class="op">)</span>,
         <span class="co"># remove a few sites we don't care about</span>
         <span class="op">!</span><span class="va">site_code</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LWE"</span>, <span class="st">"ICICLC"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="query-flowlines" class="section level3">
<h3 class="hasAnchor">
<a href="#query-flowlines" class="anchor"></a>Query Flowlines</h3>
<p>The user may also be interested in getting the flowlines (i.e., the stream or river network), for their sites of interest. <code>PITcleanr</code> provide the function <code><a href="../reference/queryFlowlines.html">queryFlowlines()</a></code> to accomplish that. <code><a href="../reference/queryFlowlines.html">queryFlowlines()</a></code> downloads an <a href="https://www.epa.gov/waterdata/nhdplus-national-hydrography-dataset-plus">NHDPlus v2</a> stream layer from USGS using the suggested <code>nhdplusTools</code> R package. It requires the spatial location of sites as an <code>sf</code> object (such as the output of <code><a href="../reference/extractSites.html">extractSites()</a></code>), and a site code identified as the “root” site. The root site might correspond with your tagging or release location and is provided to the <code>root_site_code</code> argument. The function starts from the <code>root_site_code</code> and downloads all flowlines upstream from there, with a minimum stream order set by <code>min_strm_order</code>.</p>
<p>If flowlines downstream of the <code>root_site_code</code> site are required, set the argument <code>dwnstrm_sites = TRUE</code> (default is <code>FALSE</code>). This might be useful if the user is interesting in analyzing or modeling sites downstream of the release site. If you’re not interested in analyzing/modeling downstream sites you can set <code>dwnstrm_sites = FALSE</code> which may speed up the function considerably.</p>
<p>The user can also control the minimum stream order of the downstream flowlines by setting the <code>dwn_min_stream_order_diff</code> argument. Note: smaller stream orders = smaller streams. This can be useful if the user is not interested or wants to prevent downloading all sorts of tiny streams downstream of a tagging or release location; the <code>dwn_min_stream_order_diff</code> is an attempt to constrain the amount of flowlines downloaded downstream of the <code>root_site_code</code> which can be sizable. The <code>dwn_min_stream_order_diff</code> corresponds to the difference between the stream order of the <code>root_site_code</code> site and the minimum stream order desired in the downstream flowlines. In our example, our <code>root_site_code</code> is located on a stream order of 5 (Wenatchee River) and <code>dwn_min_stream_order_diff = 2</code>, in this case only downstream flowlines of at least 5-2 = <strong>3</strong> will be downloaded. The extent of the downstream flowlines is further constrained by the <code>sites_sf</code> object. The <code><a href="../reference/queryFlowlines.html">queryFlowlines()</a></code> function returns a list consisting of: * <code>flowlines</code>: the flowlines upstream of the <code>root_site_code</code> * <code>basin</code>: the polygon containing the upstream flowlines * <code>dwn_flowlines</code>: the flowlines downstream of the <code>root_site_code</code>, if <code>dwnstrm_sites = T</code></p>
<p>Note, depending on the spatial extent of your flowlines, the <code><a href="../reference/queryFlowlines.html">queryFlowlines()</a></code> function may take awhile. Here we create a list of objects, <code>nhd_list</code>. We then use the function <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> to combine the <code>nhd$flowlines</code> and <code>nhd$dwn_flowlines</code> into a single <code>flowlines</code> simple feature object. More information on the <code>nhdplusTools</code> R package can be found <a href="https://cran.r-project.org/web/packages/nhdplusTools/index.html">here</a>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># query the flowlines</span>
<span class="va">nhd_list</span> <span class="op">=</span> <span class="fu"><a href="../reference/queryFlowlines.html">queryFlowlines</a></span><span class="op">(</span>sites_sf <span class="op">=</span> <span class="va">sites_sf</span>,
                          root_site_code <span class="op">=</span> <span class="st">"TUM"</span>,
                          min_strm_order <span class="op">=</span> <span class="fl">2</span>,
                          dwnstrm_sites <span class="op">=</span> <span class="cn">T</span>,
                          dwn_min_stream_order_diff <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; Querying streams upstream of TUM </span>
<span class="co">#&gt; Calculating furthest mainstem point downstream </span>
<span class="co">#&gt; Querying streams downstream of TUM</span>

<span class="co"># compile the upstream and downstream flowlines</span>
<span class="va">flowlines</span> <span class="op">=</span> <span class="va">nhd_list</span><span class="op">$</span><span class="va">flowlines</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">nhd_list</span><span class="op">$</span><span class="va">dwn_flowlines</span><span class="op">)</span></code></pre></div>
<p>You’ve now extracted your sites of interest and downloaded the flowlines that connect them. These two pieces of information can then be used to determine the “parent-child” relationships among your sites.</p>
</div>
<div id="parent-child-relationships" class="section level3">
<h3 class="hasAnchor">
<a href="#parent-child-relationships" class="anchor"></a>“Parent-Child” Relationships</h3>
<p>When dealing with detections of individual tags, the user often is interested in which locations are connected to which other locations along the stream network. One way to capture this information is through the construction of a parent-child table describing the “relationships” among locations. In a parent-child table, each row consists of a parent location, and a child location that is connected directly to that parent location By default, <code>PITcleanr</code> assigns parent-child relationships as moving in an upstream direction, so a single parent may have multiple child locations upstream, if the stream network branches upstream of it. However, each child should only have a single parent, as we are assuming a lack of looped connections in our stream network. If the user is interested in a downstream parent-child relationship, the <code>parent</code> and <code>child</code> designations in the table can be manually switched. As an example, assuming only upstream movement, a weir may be considered a parent and each of its next upstream arrays considered children. A location with no detection sites further upstream has no children, but is presumably the child of a downstream location. All of the parent-child relationships among locations in a watershed can describe the potential movements by an individual tag (moving from parent to child, to the next child, etc.).</p>
<p>To help illustrate, the following depicts the parent-child relationships among nodes in our Wenatchee River example, assuming only upriver movement from Tumwater Dam. More on this to follow…</p>
<p><img src="DABOM_prep_files/figure-html/parent-child-fig-1.png" width="700" style="display: block; margin: auto;"></p>
<p><code>PITcleanr</code> constructs this relationship by joining a spatial (<code>sf</code>) point object of sites with the flowlines queried via <code><a href="../reference/queryFlowlines.html">queryFlowlines()</a></code>. The NHDPlus layer that is returned contains a unique identifier, or hydrosequence, for every segment, as well as the identifier of the hydrosequence immediately upstream and downstream. Using this information, <code>PITcleanr</code> can identify the next downstream site from every known location (using the <code><a href="../reference/findDwnstrmSite.html">findDwnstrmSite()</a></code> function), and thus construct the parent child table through the <code><a href="../reference/buildParentChild.html">buildParentChild()</a></code> function. By default, <code><a href="../reference/buildParentChild.html">buildParentChild()</a></code> returns a tibble identifying every parent-child pair, as well as the hydrosequence joined to the parent and child location. If the argument <code>add_rkm</code> is set to <code>TRUE</code>, <code>PITcleanr</code> will query the PTAGIS metadata again, and attach the river kilometer (or rkm) for each parent and child location.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parent_child</span> <span class="op">=</span> <span class="fu"><a href="../reference/buildParentChild.html">buildParentChild</a></span><span class="op">(</span><span class="va">sites_sf</span>,
                                <span class="va">flowlines</span><span class="op">)</span>
<span class="co">#&gt; Error in findDwnstrmHydroseg(hydro_dn, flow_lines, hydro_pause_ids) : </span>
<span class="co">#&gt;   HydroSeq 50011087 not found within flow lines.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Error in findDwnstrmHydroseg(hydro_dn, flow_lines, hydro_pause_ids) : </span>
<span class="co">#&gt;   HydroSeq 50016572 not found within flow lines.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Error in findDwnstrmHydroseg(hydro_dn, flow_lines, hydro_pause_ids) : </span>
<span class="co">#&gt;   HydroSeq 50011087 not found within flow lines.</span>
<span class="va">parent_child</span>
<span class="co">#&gt; # A tibble: 13 x 4</span>
<span class="co">#&gt;    parent child parent_hydro child_hydro</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 ICL    TUM       50012366    50013200</span>
<span class="co">#&gt;  2 ICL    ICM       50012366    50017117</span>
<span class="co">#&gt;  3 TUM    UWE       50013200    50018330</span>
<span class="co">#&gt;  4 TUM    CHL       50013200    50022268</span>
<span class="co">#&gt;  5 TUM    CHW       50013200    50045832</span>
<span class="co">#&gt;  6 UWE    LWN       50018330    50021585</span>
<span class="co">#&gt;  7 UWE    WTL       50018330    50026363</span>
<span class="co">#&gt;  8 UWE    NAL       50018330    50028949</span>
<span class="co">#&gt;  9 CHL    CHU       50022268    50023868</span>
<span class="co">#&gt; 10 NAL    NAU       50028949    50034395</span>
<span class="co">#&gt; 11 &lt;NA&gt;   ICL             NA    50012366</span>
<span class="co">#&gt; 12 &lt;NA&gt;   LNF             NA    50016752</span>
<span class="co">#&gt; 13 &lt;NA&gt;   PES             NA    50024786</span></code></pre></div>
<p>After initially building a parent-child table, there is usually some editing that needs to happen. This is necessary for a variety of reasons we’ve observed:</p>
<ul>
<li>Perhaps the latitude and longitude of a site was not correct, and it was placed on the wrong hydrosequence of the flowlines.</li>
<li>The flowlines layer from the USGS could be inaccurate around a particular area, causing the parent-child relationships to be incorrect.</li>
<li>A site may be located at the mouth of a tributary was joined to the mainstem hydrosequence of the flowline, instead of the tributary, causing problems for sites upstream and downstream of that site.</li>
</ul>
<p>For these reasons (or any others), <code>PITcleanr</code> provides a function to edit the parent-child table, <code><a href="../reference/editParentChild.html">editParentChild()</a></code>. It requires a list the length of rows to be fixed (<code>fix_list</code>). Each element of this list is a vector of length 3, where the first two elements contain the parent and child locations to be edited, and the third element is the new (correct) parent location. As each child contains a single parent in the table, this is enough information to uniquely target individual rows of the parent-child table.</p>
<p>The user can also switch parent-child pairs, making the parent the child and vice versa, using the <code>switch_parent_child</code> argument. This is primarily intended to fix relationships between a root site and the initial downstream sites. If, by default, the parent child table is built assuming upstream movement, but the user would like to incorporate downstream movement from the root site to a location downstream, this argument will be useful. However, it will not “fix” associated parent-child relationships with the locations in the <code>switch_parent_child</code> list; those must be fixed through the <code>fix_list</code> argument.</p>
<p>In the example below, the original parent-child table had some problems with 2 sites (ICL and PES) downstream of the root site, TUM. In addition, the flowlines are not accurate near the confluence of Icicle Creek and the mainstem Wenatchee river, which has thrown off some of the relationships between ICL and surrounding sites. We would like to make TUM the parent of both ICL and PES, and ICL should be the parent of ICM, not LNF. In addition, ICL was placed on the mainstem river due to a mistake in the flowlines, and therefore listed as a parent of TUM, so we’d like to switch that. All of these corrections are implemented below using the <code><a href="../reference/editParentChild.html">editParentChild()</a></code> function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parent_child</span> <span class="op">=</span> <span class="fu"><a href="../reference/editParentChild.html">editParentChild</a></span><span class="op">(</span><span class="va">parent_child</span>,
                               fix_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"ICL"</span>, <span class="st">"TUM"</span><span class="op">)</span>,
                                               <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"PES"</span>, <span class="st">"TUM"</span><span class="op">)</span>,
                                               <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"LNF"</span>, <span class="st">"ICL"</span><span class="op">)</span>,
                                               <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LNF"</span>, <span class="st">'ICM'</span>, <span class="st">'ICL'</span><span class="op">)</span><span class="op">)</span>,
                               switch_parent_child <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ICL"</span>, <span class="st">'TUM'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># view corrected parent_child table</span>
<span class="va">parent_child</span>
<span class="co">#&gt; # A tibble: 12 x 4</span>
<span class="co">#&gt;    parent child parent_hydro child_hydro</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 ICL    LNF       50012366    50016752</span>
<span class="co">#&gt;  2 ICL    ICM       50012366    50017117</span>
<span class="co">#&gt;  3 TUM    ICL       50013200    50012366</span>
<span class="co">#&gt;  4 TUM    UWE       50013200    50018330</span>
<span class="co">#&gt;  5 TUM    CHL       50013200    50022268</span>
<span class="co">#&gt;  6 TUM    PES       50013200    50024786</span>
<span class="co">#&gt;  7 TUM    CHW       50013200    50045832</span>
<span class="co">#&gt;  8 UWE    LWN       50018330    50021585</span>
<span class="co">#&gt;  9 UWE    WTL       50018330    50026363</span>
<span class="co">#&gt; 10 UWE    NAL       50018330    50028949</span>
<span class="co">#&gt; 11 CHL    CHU       50022268    50023868</span>
<span class="co">#&gt; 12 NAL    NAU       50028949    50034395</span></code></pre></div>
<p>Note, if the configuration file contains multiple nodes for some sites (e.g., a node for each array at a site), then the parent-child table can be expanded to accommodate these nodes using the <code><a href="../reference/addParentChildNodes.html">addParentChildNodes()</a></code> function. The function essentially “expands” (adds rows) to the existing parent-child table to accommodate those additional nodes. Note: the <code><a href="../reference/addParentChildNodes.html">addParentChildNodes()</a></code> function assumes that the parent-child table is arranged so that children are upstream of parents, and nodes designated as <code>A0</code> are upstream of those designated <code>B0</code>. Currently, the function can only handle up to two nodes at each site.</p>
<p>Here, we use the <code><a href="../reference/addParentChildNodes.html">addParentChildNodes()</a></code> function on our existing <code>parent_child</code> table, and provide our existing <code>configuration</code> tibble to the <code>configuration</code> argument to expand the tibble. Our results are saved to a new object <code>parent_child_nodes</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parent_child_nodes</span> <span class="op">=</span> <span class="fu"><a href="../reference/addParentChildNodes.html">addParentChildNodes</a></span><span class="op">(</span><span class="va">parent_child</span>,
                                         configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span>

<span class="co"># view expanded parent-child table</span>
<span class="va">parent_child_nodes</span>
<span class="co">#&gt; # A tibble: 22 x 4</span>
<span class="co">#&gt;    parent child parent_hydro child_hydro</span>
<span class="co">#&gt;    &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 ICLB0  ICLA0     50012366    50012366</span>
<span class="co">#&gt;  2 ICLA0  LNF       50012366    50016752</span>
<span class="co">#&gt;  3 ICLA0  ICMB0     50012366    50017117</span>
<span class="co">#&gt;  4 TUM    ICLB0     50013200    50012366</span>
<span class="co">#&gt;  5 TUM    UWE       50013200    50018330</span>
<span class="co">#&gt;  6 TUM    CHLB0     50013200    50022268</span>
<span class="co">#&gt;  7 TUM    PESB0     50013200    50024786</span>
<span class="co">#&gt;  8 TUM    CHWB0     50013200    50045832</span>
<span class="co">#&gt;  9 ICMB0  ICMA0     50017117    50017117</span>
<span class="co">#&gt; 10 UWE    LWNB0     50018330    50021585</span>
<span class="co">#&gt; # … with 12 more rows</span></code></pre></div>
</div>
</div>
<div id="remove-detections-prior-to-start-location" class="section level2">
<h2 class="hasAnchor">
<a href="#remove-detections-prior-to-start-location" class="anchor"></a>Remove Detections Prior to Start Location</h2>
<p>In preparing data for DABOM, it is usually a good idea to filter the detections from PTAGIS so that each tag starts at the same site. In our example case, we are interested in detections that occur after adults are tagged at and/or released from Tumwater Dam. Therefore, we’d like to filter out any detections that occur prior to that date. In this example, we will get the date of the first detection of each tag at Tumwater Dam, which could include the mark event, and call that the <code>start_date</code>. We then want to keep any detections for a given tag that occur after that start date <code><a href="https://rdrr.io/r/stats/filter.html">filter(min_det &gt;= start_date)</a></code> i.e., the opposite of removing tags prior to that date. After, we re-calculate the slots after removing those detections so that they are orderly again.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obs</span> <span class="op">=</span> <span class="va">comp_obs</span> <span class="op">%&gt;%</span>
  <span class="co"># get the first detection of each tag at Tumwater Dam, which could include the mark</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">comp_obs</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">node</span> <span class="op">==</span> <span class="st">"TUM"</span>,
                     <span class="va">event_type_name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Mark"</span>, <span class="st">"Recapture"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu">group_by</span><span class="op">(</span><span class="va">tag_code</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">min_det</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">min_det</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
              <span class="fu">summarise</span><span class="op">(</span>start_date <span class="op">=</span> <span class="va">min_det</span>,
                        .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>,
            by <span class="op">=</span> <span class="st">"tag_code"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># keep any detections that occur after the start_date</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">min_det</span> <span class="op">&gt;=</span> <span class="va">start_date</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># re-calculate the "slots" for each tag_code</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">tag_code</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>slot <span class="op">=</span> <span class="va">slot</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">slot</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Now, all of the records for each tag code in our new <code>obs</code> object occur after that fish moved past Tumwater Dam.</p>
</div>
<div id="create-straightforward-detection-histories" class="section level2">
<h2 class="hasAnchor">
<a href="#create-straightforward-detection-histories" class="anchor"></a>Create “Straightforward” Detection Histories</h2>
<p>Based on relationships defined in the parent-child table, and the order of detections at nodes through time, <code>PITcleanr</code> can assign a direction of movement to each observation, using the function <code><a href="../reference/addDirection.html">addDirection()</a></code>. If the compressed detections have been filtered so they all start at the tagging location (see <a href="#remove-detections-prior-to-start-location">Remove Detections Prior to Start Location</a> section), then those initial observations will be labeled with direction “start”. Subsequently, “forward” indicates upstream movement, and “backward” indicates movement back downstream. A direction of “unknown” indicates the tag has shifted to a different branch in the stream network.</p>
<p>The function <code><a href="../reference/filterDetections.html">filterDetections()</a></code> incorporates those directions and adds two columns to indicate whether each detection should be retained for DABOM. For tags with straightforward detections (i.e., all detections appear to have one-way directional movement), the added columns <code>auto_keep_obs</code> and <code>user_keep_obs</code> will be marked <code>TRUE</code>. For tags with less straightforward movement patterns, <code>PITcleanr</code> assumes that the last detection with movement noted as “forward” or “unknown” (or “start”) is the spawning location, and attempts to mark the <code>auto_keep_obs</code> column as <code>TRUE</code> for the last detections along that tag’s movement path. For these tags, <code><a href="../reference/filterDetections.html">filterDetections()</a></code> returns <code>NA</code>’s in the <code>user_keep_obs</code> column. The user can later determine the “fate” of that fish; more on this in a bit.</p>
<p><code><a href="../reference/filterDetections.html">filterDetections()</a></code> also allows the user to input a maximum observed date (<code>max_obs_date</code>), which will mark all detections after that date as invalid (<code>auto_proc_obs</code> will be <code>FALSE</code>). This may be useful for steelhead to filter out kelting detections, or for Chinook salmon when ghost tags from carcasses or that were expelled during spawning may be observed.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prepped_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/filterDetections.html">filterDetections</a></span><span class="op">(</span>compress_obs <span class="op">=</span> <span class="va">obs</span>,
                              parent_child <span class="op">=</span> <span class="va">parent_child_nodes</span>,
                              max_obs_date <span class="op">=</span> <span class="st">"20150930"</span><span class="op">)</span></code></pre></div>
<p>Let’s look at an example of a fish where <code><a href="../reference/filterDetections.html">filterDetections()</a></code> identified “backward” or “unknown” directional movement:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prepped_df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">tag_code</span> <span class="op">==</span> <span class="st">"3D9.1C2DE4B17E"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">tag_code</span><span class="op">:</span><span class="va">node</span>, 
         <span class="va">min_det</span>,
         <span class="va">node_order</span><span class="op">:</span><span class="va">auto_keep_obs</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 9 x 7</span>
<span class="co">#&gt;   tag_code  node  min_det             node_order path    direction auto_keep_obs</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt; &lt;dttm&gt;                   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;lgl&gt;        </span>
<span class="co">#&gt; 1 3D9.1C2D… TUM   2015-06-10 23:59:00          1 TUM     start     TRUE         </span>
<span class="co">#&gt; 2 3D9.1C2D… CHLB0 2015-06-15 22:56:59          2 TUM CH… forward   FALSE        </span>
<span class="co">#&gt; 3 3D9.1C2D… CHLA0 2015-06-15 22:57:53          3 TUM CH… forward   FALSE        </span>
<span class="co">#&gt; 4 3D9.1C2D… CHLB0 2015-06-16 22:14:25          2 TUM CH… backward  FALSE        </span>
<span class="co">#&gt; 5 3D9.1C2D… CHLA0 2015-06-16 22:15:09          3 TUM CH… forward   FALSE        </span>
<span class="co">#&gt; 6 3D9.1C2D… CHLB0 2015-06-17 00:48:51          2 TUM CH… backward  FALSE        </span>
<span class="co">#&gt; 7 3D9.1C2D… CHLA0 2015-06-17 08:00:00          3 TUM CH… forward   FALSE        </span>
<span class="co">#&gt; 8 3D9.1C2D… WTLA0 2015-07-15 10:00:00          4 TUM UW… unknown   TRUE         </span>
<span class="co">#&gt; 9 3D9.1C2D… WTLB0 2015-09-06 19:17:56          3 TUM UW… backward  FALSE</span></code></pre></div>
<p>The next step would be for a user to filter the prepared data for all rows with <code>user_keep_obs == NA</code>, and then fill in the <code>user_keep_obs</code> column by hand for each node. These decisions could be guided by the <code>auto_keep_obs</code> column (<code>PITcleanr</code>’s best guess), but could also be informed by the date of detections and the user’s biological knowledge of the system. Before sending the data along to DABOM, all the missing <code>user_keep_obs</code> rows should be filled out.</p>
<p>Note: the user can also choose to save the output from <code><a href="../reference/filterDetections.html">filterDetections()</a></code> to an Excel workbook or .csv file by setting <code>save_file = TRUE</code> and defining a file path in the <code>file_name</code> argument, allowing the user to manipulate those records by hand. Further instructions on this are provided in the <a href="quick_prep.html">DABOM Prep “Cheatsheet”</a> vignette.</p>
</div>
</div>
<div id="the-wrapper-function" class="section level1">
<h1 class="hasAnchor">
<a href="#the-wrapper-function" class="anchor"></a>The Wrapper Function</h1>
<p>For convenience, <code>PITcleanr</code> includes a <a href="https://en.wikipedia.org/wiki/Wrapper_function">wrapper function</a> that starts with a user-defined parent-child table and either 1) the initial compressed observations or 2) the PTAGIS file and configuration file, and performs several steps:</p>
<ul>
<li>Adds a start date for each tag corresponding to the date when a tag was marked or recaptured at the starting node (<code>start_node</code>)</li>
<li>Provides an argument <code>min_obs_date</code> that will filter out observations prior to that date</li>
<li>Runs the <code><a href="../reference/filterDetections.html">filterDetections()</a></code> function</li>
<li>If desired, saves the output as a .csv or Excel file, to make it easier to examine tag histories with less than straightforward detection paths</li>
</ul>
<p>If a user has a parent-child table and configuration file built from a previous year, or by hand, this function makes it very easy to prepare a new year’s worth data for DABOM.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># using the compressed observations</span>
<span class="va">prepped_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepWrapper.html">prepWrapper</a></span><span class="op">(</span>compress_obs <span class="op">=</span> <span class="va">comp_obs</span>,
                         parent_child <span class="op">=</span> <span class="va">parent_child_nodes</span>,
                         min_obs_date <span class="op">=</span> <span class="st">"20150301"</span>,
                         max_obs_date <span class="op">=</span> <span class="st">"20150930"</span><span class="op">)</span>

<span class="co"># using the PTAGIS file and configuration file...and saving results to file</span>
<span class="va">prepped_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepWrapper.html">prepWrapper</a></span><span class="op">(</span>ptagis_file <span class="op">=</span> <span class="va">ptagis_file</span>,
                         configuration <span class="op">=</span> <span class="va">configuration</span>,
                         parent_child <span class="op">=</span> <span class="va">parent_child_nodes</span>,
                         min_obs_date <span class="op">=</span> <span class="st">"20150301"</span>,
                         max_obs_date <span class="op">=</span> <span class="st">"20150930"</span>,
                         save_file <span class="op">=</span> <span class="cn">T</span>,
                         file_name <span class="op">=</span> <span class="st">"PITcleanr_output.xlsx"</span><span class="op">)</span></code></pre></div>
</div>
<div id="what-next" class="section level1">
<h1 class="hasAnchor">
<a href="#what-next" class="anchor"></a>What Next?</h1>
<p>Congratulations, you’ve now finished the vignette to prepare data for <a href="https://github.com/BiomarkABS/DABOM">DABOM</a>. For advanced users, or users that already have their PTAGIS query output, configuration file, and parent-child file ready, consider viewing the <a href="quick_prep.html">DABOM Prep “Cheatsheet”</a> vignette, which can also be viewed using:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"quick_prep"</span>,
         package <span class="op">=</span> <span class="st">"PITcleanr"</span><span class="op">)</span></code></pre></div>
<div id="end-vignette" class="section level4">
<h4 class="hasAnchor">
<a href="#end-vignette" class="anchor"></a>End Vignette</h4>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin See.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
